<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendify - Sign Up</title>
    <link rel="icon" type="image/png" href="logo_attendify1.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="styles/signup.css" />
  </head>
  <body>
    <div class="signup-container">
      <div class="signup-header">
        <h1 class="signup-title">Create Account</h1>
        <p class="signup-subtitle">
          Join Attendiy and start managing attendance efficiently
        </p>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i> Account created successfully!
        Redirecting...
      </div>

      <form id="signupForm">
        <div class="profile-picture-upload">
          <div class="profile-picture-preview" id="profilePicturePreview">
            <i class="fas fa-user"></i>
            <img id="previewImage" src="#" alt="Profile Preview" />
          </div>
          <label for="profilePicture" class="profile-picture-label">
            <i class="fas fa-camera"></i> Upload Photo
          </label>

          <input
            type="file"
            id="profilePicture"
            class="profile-picture-input"
            accept="image/*"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="firstName">First Name</label>
            <input
              type="text"
              id="firstName"
              class="form-input"
              placeholder="Enter your first name"
              required
            />
            <i class="fas fa-user input-icon"></i>
            <div class="error-message">First name is required</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="lastName">Last Name</label>
            <input
              type="text"
              id="lastName"
              class="form-input"
              placeholder="Enter your last name"
              required
            />
            <i class="fas fa-user input-icon"></i>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="email">Email</label>
          <input
            type="email"
            id="email"
            class="form-input"
            placeholder="Enter your email"
            required
          />
          <i class="fas fa-envelope input-icon"></i>
          <div class="error-message">Please enter a valid email address</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Password</label>
          <input
            type="password"
            id="password"
            class="form-input"
            placeholder="Create a password (min. 8 characters)"
            required
          />
          <i class="fas fa-lock input-icon"></i>
          <div class="error-message">
            Password must be at least 8 characters
          </div>
          <div class="password-strength">
            <div class="password-strength-bar" id="passwordStrengthBar"></div>
          </div>
          <div class="password-strength-text" id="passwordStrengthText">
            Password strength: Weak
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="confirmPassword"
            >Confirm Password</label
          >
          <input
            type="password"
            id="confirmPassword"
            class="form-input"
            placeholder="Confirm your password"
            required
          />
          <i class="fas fa-lock input-icon"></i>
          <div class="error-message">Passwords do not match</div>
        </div>
        <div class="form-group verification-agreement">
          <p class="verification-info">
            <i class="fas fa-info-circle"></i>
            We'll send a verification code to your email to confirm your
            account.
          </p>
        </div>

        <button type="submit" class="btn-signup">
          <span>Create Account</span>
          <div class="spinner"></div>
        </button>
        <div class="login-link">
          Already have an account? <a href="login.html">Login</a>
        </div>
      </form>
    </div>

    <!--email verification modal -->
    <div class="modal" id="emailVerificationModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Verify Your Email</h2>
          <button type="button" class="modal-close" id="closeVerificationModal">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="verification-message">
            <i class="fas fa-envelope"></i>
            <div class="verification-text">
              <p>
                A verification code has been sent to
                <strong id="verificationEmail"></strong>
              </p>
              <p>
                Please check your inbox (and spam folder) and enter the 6-digit
                code below.
              </p>
            </div>
          </div>
          <div class="verification-code-container">
            <div class="verification-code-input">
              <input
                type="text"
                id="digit1"
                class="code-digit"
                maxlength="1"
                pattern="[0-9]"
                inputmode="numeric"
              />
              <input
                type="text"
                id="digit2"
                class="code-digit"
                maxlength="1"
                pattern="[0-9]"
                inputmode="numeric"
              />
              <input
                type="text"
                id="digit3"
                class="code-digit"
                maxlength="1"
                pattern="[0-9]"
                inputmode="numeric"
              />
              <input
                type="text"
                id="digit4"
                class="code-digit"
                maxlength="1"
                pattern="[0-9]"
                inputmode="numeric"
              />
              <input
                type="text"
                id="digit5"
                class="code-digit"
                maxlength="1"
                pattern="[0-9]"
                inputmode="numeric"
              />
              <input
                type="text"
                id="digit6"
                class="code-digit"
                maxlength="1"
                pattern="[0-9]"
                inputmode="numeric"
              />
            </div>
          </div>
          <div class="verification-error" id="verificationError">
            Incorrect verification code. Please try again.
          </div>
          <div class="resend-code">
            Didn't receive the code?
            <button id="resendCodeBtn" class="resend-btn">Resend code</button>
            <div class="resend-timer" id="resendTimer">
              Resend in <span id="resendCountdown">60</span>s
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-verify" id="verifyCodeBtn">
            <span>Verify</span>
            <div class="spinner"></div>
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const signupForm = document.getElementById("signupForm");
        const firstNameInput = document.getElementById("firstName");
        const lastNameInput = document.getElementById("lastName");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const confirmPasswordInput = document.getElementById("confirmPassword");
        const successMessage = document.getElementById("successMessage");
        const progressFill = document.getElementById("progressFill");
        const passwordStrengthBar = document.getElementById(
          "passwordStrengthBar"
        );
        const passwordStrengthText = document.getElementById(
          "passwordStrengthText"
        );

        // Modal elements
        const emailVerificationModal = document.getElementById('emailVerificationModal');
        const verificationEmail = document.getElementById('verificationEmail');
        const closeVerificationModal = document.getElementById('closeVerificationModal');
        const codeDigits = document.querySelectorAll(".code-digit");
        const verificationError = document.getElementById('verificationError');
        const resendCodeBtn = document.getElementById('resendCodeBtn');
        const resendTimer = document.getElementById('resendTimer');
        const resendCountdown = document.getElementById('resendCountdown');
        const verifyCodeBtn = document.getElementById('verifyCodeBtn');

        const formInputs = [
          firstNameInput,
          lastNameInput,
          emailInput,
          passwordInput,
          confirmPasswordInput,
        ];
        let filledInputs = 0;
        let verificationCode = ""; 

        function updateProgress() {
          filledInputs = 0;

          formInputs.forEach((input) => {
            if (input.value.trim() !== "") filledInputs++;
          });

          const progress = (filledInputs / formInputs.length) * 100;
          progressFill.style.width = `${progress}%`;
        }

        formInputs.forEach((input) => {
          input.addEventListener("input", updateProgress);
        });

        passwordInput.addEventListener("input", function () {
          const password = this.value;
          let strength = 0;
          let strengthText = "Weak";
          let strengthColor = "#ef4444"; //red

          if (password.length >= 8) strength += 25;
          if (password.match(/[a-z]+/)) strength += 25;
          if (password.match(/[A-Z]+/)) strength += 25;
          if (password.match(/[0-9]+/)) strength += 25;

          if (strength === 100) {
            strengthText = "Strong";
            strengthColor = "#10b981"; //green
          } else if (strength === 75) {
            strengthText = "Good";
            strengthColor = "#10b981"; //green
          } else if (strength === 50) {
            strengthText = "Fair";
            strengthColor = "#f59e0b"; //yellow
          }

          passwordStrengthBar.style.width = `${strength}%`;
          passwordStrengthBar.style.backgroundColor = strengthColor;
          passwordStrengthText.textContent = `Password strength: ${strengthText}`;
          passwordStrengthText.style.color = strengthColor;
        });

        confirmPasswordInput.addEventListener("input", function () {
          if (this.value !== passwordInput.value && this.value !== "") {
            this.classList.add("error");
          } else {
            this.classList.remove("error");
          }
        });

        emailInput.addEventListener("input", function () {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(this.value) && this.value !== "") {
            this.classList.add("error");
          } else {
            this.classList.remove("error");
          }
        });

         //set up code digit input fields for automatic focus
          codeDigits.forEach((digit, index) => {
            digit.addEventListener("input", function () { // Corrected typo
              //allow only numbers
              this.value = this.value.replace(/[^0-9]/g, "");

              if (this.value.length === 1) {
                if (index < codeDigits.length - 1) {
                  codeDigits[index + 1].focus();
                } else if (index === codeDigits.length - 1) {
                  //confirm the code automatically if it's the last digit
                  // Optional: verifyCode(); // You might want to trigger verification on button click instead
                  verifyCodeBtn.focus(); // Focus the verify button
                }
              }
            });

            digit.addEventListener("keydown", function (e) { // Moved keydown listener here
              if (e.key === "Backspace" && this.value === "" && index > 0) {
                codeDigits[index - 1].focus();
              }
            });
          });

        signupForm.addEventListener("submit", function (e) {
          e.preventDefault();

          let isValid = true;

          if (firstNameInput.value.trim() === "") {
            firstNameInput.classList.add("error");
            isValid = false;
          } else {
            firstNameInput.classList.remove("error");
          }

          if (lastNameInput.value.trim() === "") {
            lastNameInput.classList.add("error");
            isValid = false;
          } else {
            lastNameInput.classList.remove("error");
          }

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(emailInput.value)) {
            emailInput.classList.add("error");
            isValid = false;
          } else {
            emailInput.classList.remove("error");
          }

          if (passwordInput.value.length < 8) {
            passwordInput.classList.add("error");
            isValid = false;
          } else {
            passwordInput.classList.remove("error");
          }

          if (confirmPasswordInput.value !== passwordInput.value) {
            confirmPasswordInput.classList.add("error");
            isValid = false;
          } else {
            confirmPasswordInput.classList.remove("error");
          }

          if (!isValid) return;


          const button = this.querySelector('button[type="submit"]');
          button.classList.add("loading");
          button.disabled = true;

          setTimeout(() => {
            sendVerificationCode();
        },500);
      }); 

        const profilePicture = document.getElementById("profilePicture");
        const previewImage = document.getElementById("previewImage");
        const profileIcon = document.querySelector(
          ".profile-picture-preview i"
        );

        profilePicture.addEventListener("change", function (e) {
          if (this.files && this.files[0]) {
            //makes sure that the user selected a file
            const reader = new FileReader();

            reader.onload = function (e) {
              previewImage.src = e.target.result; //takes the Data URL string and sets it as the src attribure of previewImage
              previewImage.style.display = "block";
              profileIcon.style.display = "none";
            };

            reader.readAsDataURL(this.files[0]); //convert the image file contents into a Data URL format
          }
        });

      //generate and send verification code
      function sendVerificationCode(){
       verificationCode="123456";//for testing only
       const signupButton = signupForm.querySelector('button[type="submit"]'); 
       verificationEmail.textContent=emailInput.value;
       emailVerificationModal.classList.add("active");
       codeDigits.forEach((digit) => (digit.value =""));
       codeDigits[0].focus();
       verificationError.style.display="none";
       startResendTimer();
       //remove loading state from signup button
       signupButton.classList.remove("loading");
       signupButton.disabled=false;
      }

      let timer; // Declare timer globally

      function startResendTimer() {
        clearInterval(timer); // Clear any existing timer

        let timeLeft = 60;
        resendCountdown.textContent = timeLeft;
        resendCodeBtn.disabled = true;
        resendTimer.style.display = "block";

        timer = setInterval(() => {
          timeLeft--;
          resendCountdown.textContent = timeLeft;

          if (timeLeft <= 0) {
            clearInterval(timer);
            resendCodeBtn.disabled = false;
            resendTimer.style.display = "none";
          }
        }, 1000);
      }

      //close verification modal 
      closeVerificationModal.addEventListener("click", function(){
        emailVerificationModal.classList.remove("active");
      });

      resendCodeBtn.addEventListener("click", function(){
        sendVerificationCode();
      });
      
      verifyCodeBtn.addEventListener("click", function(){ // Corrected typo
        verifyCode();
      });

      function verifyCode(){
        let enteredCode ="";
        codeDigits.forEach((digit) =>{
          enteredCode+= digit.value;
        });

        if(enteredCode.length !== 6){
          verificationError.textContent="Please enter all 6 digits";
          verificationError.style.display="block";
          return;
        }

        verifyCodeBtn.classList.add("loading");
        verifyCodeBtn.disabled=true;

        setTimeout(() => {
          if(enteredCode === verificationCode){
            completeSignup();
          }
          else{
            verificationError.textContent="Incorrect verification code. Please try again.";
            verificationError.style.display="block";
            verifyCodeBtn.classList.remove("loading");
            verifyCodeBtn.disabled=false;
          }
        }, 1000);
      }
      function completeSignup(){
        emailVerificationModal.classList.remove("active");

        localStorage.setItem(
          "userName",
          `${firstNameInput.value} ${lastNameInput.value}`
        );
        localStorage.setItem("setupFaceScan", "true");
        window.location.href="face-setup.html?from=signup"
      }

    });
    </script>
  </body>
</html>
